name: Lighthouse
on: [push]
jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Use Node.js 10.x
        uses: actions/setup-node@v1
        with:
          node-version: 10.x
      - name: Get npm cache directory
        id: npm-cache
        run: |
          echo "::set-output name=dir::$(npm config get cache)"
      - uses: actions/cache@v1
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-
      - name: Installing node modules and building the app
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          # REACT_APP_DEPLOYED_TO: production
          # REACT_APP_AUTH_DOMAIN: tourlane.eu.auth0.com
          # REACT_APP_AUTH_CLIENT_ID: phOFy5l3ZEv0ntBpa4x6PpMqpoA2yjJk
          # REACT_APP_AUTH_AUDIENCE: https://kiwi.tourlane.com
          # REACT_APP_GOOGLE_MAP_API_KEY: AIzaSyAIy4Paa44QA0130pL0Ulov2K-H0V7xmM0
          # REACT_APP_KIWI_SEARCH_API: https://kiwi.tourlane.com/search/v1/items
          # REACT_APP_KIWI_CONTENT_API: https://kiwi.tourlane.com/content
          # REACT_APP_KIWI_SUPPLIERS_API: https://kiwi.tourlane.com/prices/dmcs.json
          # REACT_APP_OSM_SEARCH_API: https://nominatim.openstreetmap.org
          # REACT_APP_SENTRY_DSN: https://eab8e1b80d9e484b97466e71a7d4c15c@sentry.io/1511575
          # REACT_APP_IMGIX_URL: https://tourlane-trips-assets-production.imgix.net
          # GENERATE_SOURCEMAP: false
          # REACT_APP_SHUTTERSTOCK_CLIENT: 165c4-effca-5cade-d4084-84714-ffdf1
          # REACT_APP_SHUTTERSTOCK_SECRET: f5b72-22a0d-56b4d-1477d-bf062-6cb07
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm install
          npm run build
      - name: run Lighthouse CI
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          npm install -g @lhci/cli@0.3.x
          npm run lighthouse
          lhci upload
